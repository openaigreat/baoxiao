{% extends "base.html" %}

{% block content %}
<div class="card shadow">
    <div class="card-body">
        <h2 class="card-title mb-4">编辑报销单 #{{ reimbursement.id }}
            {% if reimbursement.status == '草稿' %}
            <span class="badge bg-secondary">草稿</span>
            {% elif reimbursement.status == '已提交' %}
            <span class="badge bg-primary">已提交</span>
            {% elif reimbursement.status == '审核中' %}
            <span class="badge bg-info">审核中</span>
            {% elif reimbursement.status == '已批准' %}
            <span class="badge bg-success">已批准</span>
            {% elif reimbursement.status == '已拒绝' %}
            <span class="badge bg-danger">已拒绝</span>
            {% endif %}
            
            {% if reimbursement.status != '草稿' %}
            <a href="{{ url_for('reimbursements.export_reimbursement', reimbursement_id=reimbursement.id) }}" 
               class="btn btn-sm btn-outline-primary float-end ms-2">导出分类汇总结果</a>
            {% endif %}
            
            {% if reimbursement.status == '草稿' or reimbursement.status == '已拒绝' %}
            <button type="button" class="btn btn-sm btn-danger float-end" id="delete-reimbursement-btn">删除</button>
            {% endif %}
        </h2>
        
        <!-- 报销单基本信息 -->
        <div class="mb-6">
            <form method="POST" action="{{ url_for('reimbursements.edit_reimbursement', reimbursement_id=reimbursement.id) }}">
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="submit_date" class="form-label">提交日期 <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="submit_date" name="submit_date" required value="{{ reimbursement.submit_date }}">
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">创建时间</label>
                        <div class="form-control-plaintext">
                            {{ reimbursement.created_at }}
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="note" class="form-label">备注</label>
                    <textarea class="form-control" id="note" name="note" rows="3">{{ reimbursement.note or '' }}</textarea>
                </div>
                
                {% if reimbursement.status == '草稿' or reimbursement.status == '已拒绝' %}
                <div class="mt-4">
                    <button type="submit" name="action" value="update" class="btn btn-primary me-2">保存修改</button>
                    
                    {% if attached_expenses|length > 0 %}
                    <button type="submit" name="action" value="submit" class="btn btn-success me-2">提交报销</button>
                    {% endif %}
                    
                    <a href="{{ url_for('reimbursements.reimbursements') }}" class="btn btn-secondary">返回列表</a>
                </div>
                {% else %}
                <div class="mt-4">
                    <a href="{{ url_for('reimbursements.reimbursements') }}" class="btn btn-secondary">返回列表</a>
                </div>
                {% endif %}
            </form>
        </div>
        
        <!-- 回款记录 -->
         <div class="mb-6">
             <h3 class="mb-3">回款记录</h3>
              
             <!-- 回款统计 -->
             <div class="card" style="margin-bottom: 20px;">
                 <div class="card-body">
                     <div class="row">
                         <div class="col-md-3">
                             <div class="form-group">
                                 <label>报销总额：</label>
                                 <span class="font-weight-bold">¥{{ "%.2f"|format(attached_expenses|sum(attribute='reimbursement_amount', start=0)) }}</span>
                             </div>
                         </div>
                         <div class="col-md-3">
                             <div class="form-group">
                                 <label>已回款金额：</label>
                                 <span class="font-weight-bold text-success">¥{{ "%.2f"|format(total_paid or 0) }}</span>
                             </div>
                         </div>
                         <div class="col-md-3">
                             <div class="form-group">
                                 <label>未回款金额：</label>
                                 <span class="font-weight-bold text-danger">¥{{ "%.2f"|format((attached_expenses|sum(attribute='reimbursement_amount', start=0)) - (total_paid or 0)) }}</span>
                             </div>
                         </div>
                         <div class="col-md-3">
                             <div class="form-group">
                                 <label>当前状态：</label>
                                 <span class="font-weight-bold">
                                     {% if reimbursement.status == '已回款' %}
                                     <span class="text-success">{{ reimbursement.status }}</span>
                                     {% else %}
                                     {{ reimbursement.status }}
                                     {% endif %}
                                 </span>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
              
             <!-- 添加回款记录表单 -->
             {% if reimbursement.status != '草稿' %}
             {% set total_amount = attached_expenses|sum(attribute='reimbursement_amount', start=0) %}
             {% if total_paid < total_amount %}
             <div class="card" style="margin-bottom: 20px;">
                 <div class="card-header">添加回款记录</div>
                 <div class="card-body">
                     <form id="payment-form">
                         <div class="form-row">
                             <div class="form-group col-md-4">
                                 <label for="payment_date">回款日期 *</label>
                                 <input type="date" class="form-control" id="payment_date" name="payment_date" required value="{{ today_date }}">
                             </div>
                             <div class="form-group col-md-4">
                                 <label for="amount">回款金额 *</label>
                                 <input type="number" step="0.01" class="form-control" id="amount" name="amount" min="0.01" required>
                             </div>
                             <div class="form-group col-md-4">
                                 <label>&nbsp;</label>
                                 <button type="submit" class="btn btn-success form-control">添加回款</button>
                             </div>
                         </div>
                         <div class="form-group">
                             <label for="note">备注</label>
                             <textarea class="form-control" id="note" name="note" rows="3"></textarea>
                         </div>
                     </form>
                 </div>
             </div>
             {% else %}
             <div class="alert alert-info" style="margin-bottom: 20px;">
                 回款总额已达到或超过报销总额，无需再添加回款记录。
             </div>
             {% endif %}
             {% endif %}
              
             <!-- 回款记录：响应式布局 -->
             {% if payments %}
             <style>
                 .payment-card {
                     transition: transform 0.2s ease, box-shadow 0.2s ease;
                 }
                 .payment-card:hover {
                     transform: translateY(-2px);
                     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                 }
                 .payment-card .card-body {
                     font-size: 12px;
                 }
             </style>
             
             <!-- 移动设备：卡片式布局 -->
             <div class="row d-md-none">
                 {% for payment in payments %}
                 <div class="col-12 mb-3">
                     <div class="payment-card card">
                         <div class="card-body">
                             <div class="d-flex justify-content-between mb-2">
                                 <span class="text-muted">回款金额：</span>
                                 <span class="font-medium text-success">¥{{ "%.2f"|format(payment.amount) }}</span>
                             </div>
                             <div class="d-flex justify-content-between mb-2">
                                 <span class="text-muted">回款日期：</span>
                                 <span>{{ payment.payment_date }}</span>
                             </div>
                             {% if payment.note %}
                             <div class="d-flex justify-content-between mb-2">
                                 <span class="text-muted">备注：</span>
                                 <span>{{ payment.note }}</span>
                             </div>
                             {% endif %}
                             <div class="d-flex justify-content-between">
                                 <span class="text-muted">添加时间：</span>
                                 <span>{{ payment.created_at }}</span>
                             </div>
                         </div>
                     </div>
                 </div>
                 {% endfor %}
             </div>
             
             <!-- PC设备：表格布局 -->
             <div class="table-responsive d-none d-md-block">
                 <table class="table table-striped table-hover">
                     <thead>
                         <tr>
                             <th>回款金额</th>
                             <th>回款日期</th>
                             <th>备注</th>
                             <th>添加时间</th>
                         </tr>
                     </thead>
                     <tbody>
                         {% for payment in payments %}
                         <tr>
                             <td class="text-success font-medium">¥{{ "%.2f"|format(payment.amount) }}</td>
                             <td>{{ payment.payment_date }}</td>
                             <td>{{ payment.note or '-' }}</td>
                             <td>{{ payment.created_at }}</td>
                         </tr>
                         {% endfor %}
                     </tbody>
                 </table>
             </div>
             {% else %}
             <div class="card text-center p-4">
                 <p class="text-muted">暂无回款记录</p>
             </div>
             {% endif %}
         </div>
        
        <!-- 已关联支出记录 -->
        <div class="mb-6">
            <h3 class="mb-3">已关联支出记录 ({{ attached_expenses|length }})</h3>
            
            <style>
                .attached-expense-card {
                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                }
                .attached-expense-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                }
                .attached-expense-card .card-body {
                    font-size: 12px;
                }
                .attached-expense-card .card-title {
                    font-size: 14px;
                }
            </style>
            
            <!-- 已关联支出记录：响应式布局 -->
            
            <!-- 移动设备：卡片式布局 -->
            <div class="row d-md-none">
                {% for expense in attached_expenses %}
                <div class="col-12 mb-4">
                    <div class="attached-expense-card card h-100">
                        <div class="card-body">
                            <!-- 头部：用途 -->
                            <h5 class="card-title mb-3">{{ expense.purpose }}</h5>
                            
                            <!-- 金额信息 -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">支出金额：</span>
                                    <span>¥{{ "%.2f"|format(expense.amount) }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">报销金额：</span>
                                    <span class="font-medium">¥{{ "%.2f"|format(expense.reimbursement_amount) }}</span>
                                </div>
                            </div>
                            
                            <!-- 详细信息 -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">日期：</span>
                                    <span>{{ expense.date }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">项目：</span>
                                    <span>{{ expense.project_name or '未分配' }}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">类别：</span>
                                    <span>{{ expense.category or '未分类' }}</span>
                                </div>
                                {% if expense.note %}
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">备注：</span>
                                    <span>{{ expense.note }}</span>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- 操作按钮 -->
                            {% if reimbursement.status == '草稿' or reimbursement.status == '已拒绝' %}
                            <div class="text-end">
                                <button class="btn btn-sm btn-danger remove-expense" 
                                        data-expense-id="{{ expense.id }}" 
                                        data-reimbursement-id="{{ reimbursement.id }}">
                                    移除
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- PC设备：表格布局 -->
            <div class="table-responsive d-none d-md-block">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>用途</th>
                            <th>支出金额</th>
                            <th>报销金额</th>
                            <th>日期</th>
                            <th>项目</th>
                            <th>类别</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for expense in attached_expenses %}
                        <tr>
                            <td>{{ expense.purpose }}</td>
                            <td>¥{{ "%.2f"|format(expense.amount) }}</td>
                            <td>¥{{ "%.2f"|format(expense.reimbursement_amount) }}</td>
                            <td>{{ expense.date }}</td>
                            <td>{{ expense.project_name or '未分配' }}</td>
                            <td>{{ expense.category or '未分类' }}</td>
                            <td>{{ expense.note or '-' }}</td>
                            <td>
                                {% if reimbursement.status == '草稿' or reimbursement.status == '已拒绝' %}
                                <button class="btn btn-sm btn-danger remove-expense" 
                                        data-expense-id="{{ expense.id }}" 
                                        data-reimbursement-id="{{ reimbursement.id }}">
                                    移除
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- 总计信息 -->
            {% if attached_expenses %}
            <div class="mt-4 p-3 bg-info-subtle rounded">
                <div class="d-flex justify-content-end">
                    <span class="text-lg font-bold">总计：¥{{ "%.2f"|format(attached_expenses|sum(attribute='reimbursement_amount', start=0)) }}</span>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- 添加支出记录 -->
        {% if (reimbursement.status == '草稿' or reimbursement.status == '已拒绝') %}
        <div class="alert alert-info">
            <p>请从 <a href="{{ url_for('stats.stats') }}">支出记录列表</a> 页面，使用"批量添加到报销单"功能将支出记录添加到本报销单。</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// 创建一个临时通知元素的函数
function showNotification(message, type = 'success') {
    // 创建通知元素
    const notification = document.createElement('div');
    notification.className = `notification-toast alert alert-${type} z-50 p-4 shadow-lg rounded text-center`;
    notification.style.position = 'fixed';
    notification.style.top = '50%';
    notification.style.left = '50%';
    notification.style.transform = 'translate(-50%, -50%) scale(0.8)';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    notification.style.maxWidth = '90%';
    notification.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
    notification.style.opacity = '0';
    notification.innerText = message;
    
    // 添加到文档中
    document.body.appendChild(notification);
    
    // 显示通知
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translate(-50%, -50%) scale(1)';
    }, 10);
    
    // 设置自动消失
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translate(-50%, -50%) scale(0.8)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    // 删除报销单按钮事件绑定
    var deleteBtn = document.getElementById('delete-reimbursement-btn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            if (!confirm('确定要删除整个报销单吗？此操作不可恢复！')) {
                return;
            }
            var reimbursementId = "{{ reimbursement.id }}";
            fetch('/reimbursements/delete_reimbursement/' + reimbursementId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('✅ 报销单删除成功！');
                    setTimeout(() => {
                        window.location.href = '/reimbursements';
                    }, 1000);
                } else {
                    showNotification('删除失败: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showNotification('提交失败: ' + error, 'danger');
            });
        });
    }
    // 处理移除支出记录
    const removeButtons = document.querySelectorAll('.remove-expense');
    removeButtons.forEach(button => {
        button.addEventListener('click', function() {
            if (!confirm('确定要从报销单中移除这条支出记录吗？')) {
                return;
            }
            
            const expenseId = this.getAttribute('data-expense-id');
            const reimbursementId = this.getAttribute('data-reimbursement-id');
            
            fetch('/reimbursements/remove_expense_from_reimbursement', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `reimbursement_id=${reimbursementId}&expense_id=${expenseId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('✅ 移除成功！');
                    // 延迟刷新页面
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showNotification('移除失败: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showNotification('提交失败: ' + error, 'danger');
            });
        });
    });

    // 添加回款记录
    const paymentForm = document.getElementById('payment-form');
    if (paymentForm) {
        paymentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const paymentDate = document.getElementById('payment_date').value;
            const amount = document.getElementById('amount').value;
            const note = document.getElementById('note').value;
            
            var reimbursementId = "{{ reimbursement.id }}";
            fetch('/reimbursements/add_reimbursement_payment/' + reimbursementId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `payment_date=${paymentDate}&amount=${amount}&note=${encodeURIComponent(note)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('✅ 回款记录添加成功！');
                    // 重置表单
                    paymentForm.reset();
                    // 延迟刷新页面以显示最新数据
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showNotification('添加失败: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showNotification('提交失败: ' + error, 'danger');
            });
        });
    }
});
</script>
{% endblock %}
