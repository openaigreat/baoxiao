{% extends "base.html" %}

{% block content %}
<style>
    .smaller-text {
        font-size: 0.6em; /* 调整为你需要的大小 */
    }
    .notification-toast {
        animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
<script>
// 创建一个临时通知元素的函数
function showNotification(message, type = 'success') {
    // 创建通知元素
    const notification = document.createElement('div');
    notification.className = `notification-toast alert alert-${type} z-50 p-4 shadow-lg rounded text-center`;
    notification.style.position = 'fixed';
    notification.style.top = '50%';
    notification.style.left = '50%';
    notification.style.transform = 'translate(-50%, -50%) scale(0.8)';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    notification.style.maxWidth = '90%';
    notification.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
    notification.style.opacity = '0';
    notification.innerText = message;
    
    // 添加到文档中
    document.body.appendChild(notification);
    
    // 显示通知
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translate(-50%, -50%) scale(1)';
    }, 10);
    
    // 设置自动消失
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translate(-50%, -50%) scale(0.8)';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
    
    return notification;
}

// 批量更新按钮状态管理
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    const batchUpdateBtn = document.getElementById('batch-update-btn');
    
    // 更新按钮状态的函数
    function updateButtonState() {
        const checkedCount = document.querySelectorAll('input[type="checkbox"]:checked').length;
        batchUpdateBtn.disabled = checkedCount === 0;
    }
    
    // 为每个复选框添加事件监听器
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateButtonState);
    });
    
    // 为批量更新按钮添加点击事件
    if (batchUpdateBtn) {
        batchUpdateBtn.addEventListener('click', function() {
            const selectedIds = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            
            if (selectedIds.length > 0) {
                // 设置选中的ID到隐藏字段
                document.getElementById('expense_ids_hidden').value = selectedIds.join(',');
                
                // 获取选中的类别
                const selectedCategory = document.querySelector('input[name="new_category"]:checked');
                if (!selectedCategory) {
                    showNotification('请先选择目标费用类别', 'warning');
                    return;
                }
                
                // 提交表单
                document.getElementById('batch-form').submit();
            }
        });
    }
});
</script>
<form method="POST" id="batch-form" action="{{ url_for('stats.batch_update_categories') }}">
    <input type="hidden" id="expense_ids_hidden" name="expense_ids_hidden" value="">
    <input type="hidden" name="category_name" value="{{ category_name }}">
    <input type="hidden" id="selected-expense-ids" name="expense_ids_hidden">
    
    <div class="card shadow mb-4">
        <div class="card-body">
            <!-- 标题和操作按钮 -->
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                <h2 class="card-title mb-0">分类明细 <small class="smaller-text">({{ category_name }}) - {{ expenses|length }}</small></h2>
                
                <div class="d-flex flex-wrap gap-2">
                    <!-- 类别选择按钮组 -->
                    <div class="btn-group btn-group-sm">
                        <input type="radio" name="new_category" id="new-category-food" value="餐费" class="btn-check" required>
                        <label for="new-category-food" class="btn btn-outline-secondary">餐费</label>
                        
                        <input type="radio" name="new_category" id="new-category-transport" value="交通" class="btn-check">
                        <label for="new-category-transport" class="btn btn-outline-secondary">交通</label>
                        
                        <input type="radio" name="new_category" id="new-category-material" value="材料" class="btn-check">
                        <label for="new-category-material" class="btn btn-outline-secondary">材料</label>
                        
                        <input type="radio" name="new_category" id="new-category-accommodation" value="住宿" class="btn-check">
                        <label for="new-category-accommodation" class="btn btn-outline-secondary">住宿</label>
                        
                        <input type="radio" name="new_category" id="new-category-manual" value="人工" class="btn-check">
                        <label for="new-category-manual" class="btn btn-outline-secondary">人工</label>
                        
                        <input type="radio" name="new_category" id="new-category-other" value="其他" class="btn-check">
                        <label for="new-category-other" class="btn btn-outline-secondary">其他</label>
                    </div>
                    
                    <!-- 批量操作按钮 -->
                    <button id="batch-update-btn" class="btn btn-sm btn-primary" disabled>
                        批量更改类别
                    </button>
                </div>
            </div>
            
            <!-- 排序选项栏 -->
            <div class="bg-light p-3 rounded mb-4">
                <div class="d-flex flex-wrap gap-3 align-items-center">
                    <div class="form-check form-check-inline">
                        <input type="checkbox" id="select-all-mobile" class="form-check-input select-all-checkbox">
                        <label for="select-all-mobile" class="form-check-label">全选</label>
                    </div>
                    
                    <div class="text-muted">排序方式:</div>
                    
                    <a href="{{ url_for('stats.category_expenses', category_name=category_name, sort_by='project_name', sort_order=(next_sort_order if current_sort == 'project_name' else 'asc')) }}" 
                       class="btn btn-sm {% if current_sort == 'project_name' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        项目
                        {% if current_sort == 'project_name' %}
                        <i class="bi bi-sort-{{ 'up' if current_order == 'asc' else 'down' }}"></i>
                        {% endif %}
                    </a>
                    
                    <a href="{{ url_for('stats.category_expenses', category_name=category_name, sort_by='date', sort_order=(next_sort_order if current_sort == 'date' else 'asc')) }}" 
                       class="btn btn-sm {% if current_sort == 'date' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        日期
                        {% if current_sort == 'date' %}
                        <i class="bi bi-sort-{{ 'up' if current_order == 'asc' else 'down' }}"></i>
                        {% endif %}
                    </a>
                    
                    <a href="{{ url_for('stats.category_expenses', category_name=category_name, sort_by='amount', sort_order=(next_sort_order if current_sort == 'amount' else 'asc')) }}" 
                       class="btn btn-sm {% if current_sort == 'amount' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        金额
                        {% if current_sort == 'amount' %}
                        <i class="bi bi-sort-{{ 'up' if current_order == 'asc' else 'down' }}"></i>
                        {% endif %}
                    </a>
                </div>
            </div>
            
            <!-- 费用列表：响应式布局 -->
            {% if expenses %}
            
            <!-- 移动设备：卡片式布局 -->
            <div class="row row-cols-1 gap-4 d-md-none">
                {% for expense in expenses %}
                <div class="col">
                    <div class="card expense-card h-100" data-id="{{ expense.id }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="form-check">
                                        <input type="checkbox" name="expense_ids" value="{{ expense.id }}" class="expense-checkbox form-check-input">
                                    </div>
                                </div>
                                <div>
                                    <span class="text-xl font-bold text-primary">¥{{ "%.2f"|format(expense.amount or 0) }}</span>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <div class="d-flex flex-wrap gap-4">
                                    <div>
                                        <small class="text-muted">项目:</small>
                                        <p>
                                            {% if expense.project_name %}
                                            <a href="{{ url_for('stats.expenses', project_id=expense.project_id) }}">
                                                {{ expense.project_name }}
                                            </a>
                                            {% else %}
                                            <span class="text-muted">未分配</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div>
                                        <small class="text-muted">日期:</small>
                                        <p>
                                            <a href="{{ url_for('stats.date_expenses', date=expense.date) }}">
                                                {{ expense.date }}
                                            </a>
                                        </p>
                                    </div>
                                    <div>
                                        <small class="text-muted">类别:</small>
                                        <p>{{ expense.category or '未分类' }}</p>
                                    </div>
                                </div>
                                
                                <div class="mt-2">
                                    <small class="text-muted">用途:</small>
                                    <p style="font-size: 12px;">{{ expense.purpose }}</p>
                                </div>
                                
                                {% if expense.note %}
                                <div class="mt-2">
                                    <small class="text-muted">备注:</small>
                                    <p style="font-size: 12px;">{{ expense.note }}</p>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="mt-3 text-right">
                                <a href="{{ url_for('stats.edit_expense', expense_id=expense.id) }}" class="btn btn-sm btn-warning">
                                    编辑
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- PC设备：表格布局 -->
            <div class="table-responsive d-none d-md-block">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th width="50%">用途</th>
                            <th>项目</th>
                            <th>
                                <div class="form-check">
                                    <input type="checkbox" id="select-all-table" class="form-check-input select-all-checkbox">
                                </div>
                            </th>
                            <th>金额</th>
                            <th>类别</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for expense in expenses %}
                        <tr class="expense-table-row">
                            <td>{{ expense.date }}</td>
                            <td>{{ expense.purpose }}</td>
                            <td>{{ expense.project_name or '无项目' }}</td>
                            <td>
                                <div class="form-check">
                                    <input type="checkbox" name="expense_ids" value="{{ expense.id }}" class="expense-checkbox form-check-input">
                                </div>
                            </td>
                            <td>¥{{ "%.2f"|format(expense.amount or 0) }}</td>
                            <td>{{ expense.category or '未分类' }}</td>
                            <td>{{ expense.note or '-' }}</td>
                            <td>
                                <a href="{{ url_for('stats.edit_expense', expense_id=expense.id) }}" class="btn btn-sm btn-warning">
                                    编辑
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- 总计卡片 -->
            <div class="card mt-4 border-primary">
                <div class="card-body">
                    <div class="text-right">
                        <span class="text-xl font-bold">总计: ¥{{ "%.2f"|format(total_amount) }}</span>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-4">
                <p class="text-muted">暂无未报销的费用记录</p>
            </div>
            {% endif %}
        </div>
    </div>
</form>

<script>
    // 更新表格行样式
    function updateTableRowStyle(checkbox) {
        const row = checkbox.closest('.expense-table-row');
        if (row) {
            if (checkbox.checked) {
                row.classList.add('bg-primary', 'bg-opacity-10');
            } else {
                row.classList.remove('bg-primary', 'bg-opacity-10');
            }
        }
    }

    // 更新项样式（同时更新卡片和表格行）
    function updateItemStyle(checkbox) {
        updateCardStyle(checkbox);
        updateTableRowStyle(checkbox);
    }
    
    // 全选/取消全选功能
    document.querySelectorAll('.select-all-checkbox').forEach(selectAllCheckbox => {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.expense-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
                updateItemStyle(checkbox);
            });
            updateBatchButton();
            updateHeaderCheckbox();
        });
    })
    
    // 卡片点击选中/取消选中
    document.querySelectorAll('.expense-card').forEach(card => {
        card.addEventListener('click', function(e) {
            // 如果点击的是复选框、按钮或链接，不触发卡片点击事件
            if (e.target.type === 'checkbox' || 
                e.target.tagName === 'BUTTON' || 
                e.target.closest('button') || 
                e.target.closest('a')) {
                return;
            }
            const checkbox = this.querySelector('.expense-checkbox');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateItemStyle(checkbox);
                updateBatchButton();
                updateHeaderCheckbox();
            }
        });
    });
    
    // 表格行点击选中/取消选中
    document.querySelectorAll('.expense-table-row').forEach(row => {
        row.addEventListener('click', function(e) {
            // 如果点击的是复选框、按钮或链接，不触发行点击事件
            if (e.target.type === 'checkbox' || 
                e.target.tagName === 'BUTTON' || 
                e.target.closest('button') || 
                e.target.closest('a') ||
                e.target.closest('.form-check')) {
                return;
            }
            const checkbox = this.querySelector('.expense-checkbox');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateItemStyle(checkbox);
                updateBatchButton();
                updateHeaderCheckbox();
            }
        });
    });
    
    // 复选框变化时更新批量按钮状态
    document.querySelectorAll('.expense-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateItemStyle(this);
            updateBatchButton();
            updateHeaderCheckbox();
        });
        
        // 防止点击复选框时触发卡片点击事件
        checkbox.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
    
    // 更新卡片样式
    function updateCardStyle(checkbox) {
        const card = checkbox.closest('.expense-card');
        if (checkbox.checked) {
            card.classList.add('border-primary', 'shadow-lg');
            card.style.backgroundColor = '#f8f9fa';
        } else {
            card.classList.remove('border-primary', 'shadow-lg');
            card.style.backgroundColor = '';
        }
    }
    
    // 更新批量按钮状态
    function updateBatchButton() {
        const checkedBoxes = document.querySelectorAll('.expense-checkbox:checked');
        const selectedCategory = document.querySelector('input[name="new_category"]:checked');
        const batchButton = document.getElementById('batch-update-btn');
        batchButton.disabled = checkedBoxes.length === 0 || !selectedCategory;
    }
    
    // 更新全选复选框状态
    function updateHeaderCheckbox() {
        const checkboxes = document.querySelectorAll('.expense-checkbox');
        const checkedBoxes = document.querySelectorAll('.expense-checkbox:checked');
        const isAllChecked = checkboxes.length > 0 && checkboxes.length === checkedBoxes.length;
        document.querySelectorAll('.select-all-checkbox').forEach(checkbox => {
            checkbox.checked = isAllChecked;
        });
    }
    
    // 监听类别选择变化
    document.querySelectorAll('input[name="new_category"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateBatchButton();
        });
    });
    
    // 批量更新按钮点击
    document.getElementById('batch-update-btn').addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('.expense-checkbox:checked');
        if (checkedBoxes.length === 0) {
            alert('请至少选择一条记录');
            return;
        }
        const selectedCategory = document.querySelector('input[name="new_category"]:checked');
        if (!selectedCategory) {
            alert('请选择新类别');
            return;
        }
        
        // 将选中的ID存储到隐藏字段中
        const selectedIds = Array.from(checkedBoxes).map(checkbox => checkbox.value);
        document.getElementById('selected-expense-ids').value = selectedIds.join(',');
        
        // 提交表单
        document.getElementById('batch-form').submit();
    });
</script>
{% endblock %}