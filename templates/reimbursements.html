{% extends "base.html" %}

{% block content %}
<div class="card shadow">
    <div class="card-body">
        <h2 class="card-title mb-4">报销单管理
            <a href="{{ url_for('reimbursements.add_reimbursement') }}" class="btn btn-sm btn-success float-end me-2">
                创建报销单
            </a>
        </h2>
        
        <!-- 报销状态统计 -->
        <div class="row mb-4">
            {% for stat in status_stats %}
            <div class="col-md-3 mb-2">
                <div class="card {% if stat.status == '草稿' %}bg-secondary-subtle{% elif stat.status == '已提交' %}bg-primary-subtle{% elif stat.status == '已批准' %}bg-success-subtle{% elif stat.status == '已拒绝' %}bg-danger-subtle{% else %}bg-info-subtle{% endif %}">
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ stat.status }}</h5>
                        <p class="card-text">共 {{ stat.count }} 笔</p>
                        <p class="card-text font-weight-bold">¥{{ "%.2f"|format(stat.total or 0) }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- 筛选表单 -->
        <div class="mb-4">
            <form id="filterForm" class="row g-3">
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">状态筛选</label>
                    <select id="statusFilter" name="status" class="form-select">
                        <option value="">全部状态</option>
                        <option value="草稿">草稿</option>
                        <option value="已提交">已提交</option>
                        <option value="审核中">审核中</option>
                        <option value="已批准">已批准</option>
                        <option value="已拒绝">已拒绝</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="dateFrom" class="form-label">开始日期</label>
                    <input type="date" id="dateFrom" name="date_from" class="form-control">
                </div>
                <div class="col-md-3">
                    <label for="dateTo" class="form-label">结束日期</label>
                    <input type="date" id="dateTo" name="date_to" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">筛选</button>
                        <button type="button" id="resetFilter" class="btn btn-secondary">重置</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- 报销单列表 -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>报销单ID</th>
                        <th>提交日期</th>
                        <th>关联支出数</th>
                        <th>报销总金额</th>
                        <th>状态</th>
                        <th>备注</th>
                        <th>创建时间</th>
                        <th>回款金额</th>
                        <th>回款日期</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reimbursement in reimbursements %}
                    <tr>
                        <td>{{ reimbursement.id }}</td>
                        <td>{{ reimbursement.submit_date }}</td>
                        <td>{{ reimbursement.expense_count }}</td>
                        <td>¥{{ "%.2f"|format(reimbursement.calculated_total or 0) }}</td>
                        <td>
                            <span class="badge {% if reimbursement.status == '草稿' %}bg-secondary{% elif reimbursement.status == '已提交' %}bg-primary{% elif reimbursement.status == '已批准' %}bg-success{% elif reimbursement.status == '已拒绝' %}bg-danger{% else %}bg-info{% endif %}">
                                {{ reimbursement.status }}
                            </span>
                        </td>
                        <td>{{ reimbursement.note or '-' }}</td>
                        <td>{{ reimbursement.created_at }}</td>
                        <td>
                            {% if reimbursement.total_paid > 0 %}
                            <span class="text-success font-weight-bold">¥{{ "%.2f"|format(reimbursement.total_paid or 0) }}</span>
                            {% else %}
                            -  
                            {% endif %}
                        </td>
                        <td>{{ reimbursement.latest_payment_date or '-' }}</td>
                        <td>
                            {% if reimbursement.status == '草稿' or reimbursement.status == '已拒绝' %}
                            <a href="{{ url_for('reimbursements.edit_reimbursement', reimbursement_id=reimbursement.id) }}" class="btn btn-sm btn-warning me-1">
                                编辑
                            </a>
                            <button type="button" class="btn btn-sm btn-danger delete-btn" data-id="{{ reimbursement.id }}">
                                删除
                            </button>
                            {% else %}
                            <a href="{{ url_for('reimbursements.edit_reimbursement', reimbursement_id=reimbursement.id) }}" class="btn btn-sm btn-outline-info">
                                查看详情
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>



<script>
// 筛选表单处理逻辑
document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // 获取表单数据
    const status = document.getElementById('statusFilter').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    // 构建URL参数
    const params = new URLSearchParams();
    if (status) params.append('status', status);
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);
    
    // 重新加载页面
    window.location.href = '/reimbursements?' + params.toString();
});

// 重置筛选按钮
const resetFilter = document.getElementById('resetFilter');
if (resetFilter) {
    resetFilter.addEventListener('click', function() {
        document.getElementById('statusFilter').value = '';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        window.location.href = '/reimbursements';
    });
}

// 页面加载时，从URL参数中恢复筛选条件
window.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    
    const status = urlParams.get('status');
    const dateFrom = urlParams.get('date_from');
    const dateTo = urlParams.get('date_to');
    
    if (status) {
        document.getElementById('statusFilter').value = status;
    }
    if (dateFrom) {
        document.getElementById('dateFrom').value = dateFrom;
    }
    if (dateTo) {
        document.getElementById('dateTo').value = dateTo;
    }
});

// 删除报销单的AJAX处理
const deleteButtons = document.querySelectorAll('.delete-btn');
deleteButtons.forEach(button => {
    button.addEventListener('click', function() {
        const reimbursementId = this.getAttribute('data-id');
        
        if (confirm('确定要删除此报销单吗？')) {
            fetch(`/delete_reimbursement/${reimbursementId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 显示成功提示
                    const message = document.createElement('div');
                    message.className = 'alert alert-success fixed-top w-50 mx-auto mt-3';
                    message.role = 'alert';
                    message.innerHTML = `<strong>成功!</strong> 报销单已删除。`;
                    document.body.appendChild(message);
                    
                    // 3秒后移除提示
                    setTimeout(() => {
                        message.remove();
                    }, 3000);
                    
                    // 从DOM中移除该行
                    this.closest('tr').remove();
                    
                    // 可以选择刷新页面或更新统计数据
                } else {
                    alert('删除失败: ' + (data.error || '未知错误'));
                }
            })
            .catch(error => {
                console.error('删除出错:', error);
                alert('删除过程中发生错误');
            });
        }
    });
});


</script>
{% endblock %}