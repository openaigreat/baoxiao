{% extends "base.html" %}

{% block content %}
<style>
    .smaller-text {
        font-size: 0.6em; /* 调整为你需要的大小 */
    }
    .expense-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .expense-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .expense-card .card-body {
        font-size: 12px;
    }
    .expense-table-row {
        font-size: 14px;
    }
    .expense-table-row td {
        vertical-align: middle;
    }
</style>
<div class="card shadow mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="card-title mb-0">孤立支出明细 </h2>
            <div class="d-flex gap-2">
                <button id="batch-assign-btn" class="btn btn-sm btn-primary" disabled>
                    归属项目
                </button>
                <button id="add-project-btn" class="btn btn-sm btn-success">
                    添加项目
                </button>
            </div>
        </div>
        
        <!-- 排序选项栏 -->
        <div class="bg-light p-3 rounded mb-4">
            <div class="d-flex flex-wrap gap-3 align-items-center">
                <div class="form-check form-check-inline">
                    <input type="checkbox" id="select-all" class="form-check-input">
                    <label for="select-all" class="form-check-label">全选</label>
                </div>
                
                <div class="text-muted">排序方式:</div>
                
                <a href="{{ url_for('stats.orphan_expenses', sort_by='date', sort_order=next_sort_order if current_sort == 'date' else 'asc') }}" 
                   class="btn btn-sm {% if current_sort == 'date' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    日期
                    {% if current_sort == 'date' %}
                        <i class="bi bi-sort-{{ 'up' if current_order == 'asc' else 'down' }}"></i>
                    {% endif %}
                </a>
                
                <a href="{{ url_for('stats.orphan_expenses', sort_by='amount', sort_order=next_sort_order if current_sort == 'amount' else 'asc') }}" 
                   class="btn btn-sm {% if current_sort == 'amount' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    金额
                    {% if current_sort == 'amount' %}
                        <i class="bi bi-sort-{{ 'up' if current_order == 'asc' else 'down' }}"></i>
                    {% endif %}
                </a>
                
                <a href="{{ url_for('stats.orphan_expenses', sort_by='category', sort_order=next_sort_order if current_sort == 'category' else 'asc') }}" 
                   class="btn btn-sm {% if current_sort == 'category' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    类别
                    {% if current_sort == 'category' %}
                        <i class="bi bi-sort-{{ 'up' if current_order == 'asc' else 'down' }}"></i>
                    {% endif %}
                </a>
                
                <a href="{{ url_for('stats.orphan_expenses', sort_by='purpose', sort_order=next_sort_order if current_sort == 'purpose' else 'asc') }}" 
                   class="btn btn-sm {% if current_sort == 'purpose' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    用途
                    {% if current_sort == 'purpose' %}
                        <i class="bi bi-sort-{{ 'up' if current_order == 'asc' else 'down' }}"></i>
                    {% endif %}
                </a>
                
                <div id="selected-stats" class="ml-auto" style="display: none;">
                    <span class="badge bg-primary">选中: <span id="selected-count">0</span>笔</span>
                    <span class="badge bg-success ml-1">合计: ¥<span id="selected-amount">0.00</span></span>
                </div>
            </div>
        </div>
        
        <!-- 支出列表：响应式布局 -->
        {% if expenses %}
        
        <!-- 移动设备：卡片式布局 -->
        <div class="expense-cards d-md-none">
            {% for expense in expenses %}
            <div class="card mb-3 expense-card" data-id="{{ expense.id }}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="form-check">
                                <input type="checkbox" class="expense-checkbox form-check-input" value="{{ expense.id }}">
                            </div>
                        </div>
                        <div>
                            <span class="text-xl font-bold text-primary">¥{{ "%.2f"|format(expense.amount or 0) }}</span>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="d-flex flex-wrap gap-4">
                            <div>
                                <small class="text-muted">日期:</small>
                                <p style="font-size: 12px;">{{ expense.date }}</p>
                            </div>
                            <div>
                                <small class="text-muted">类别:</small>
                                <p style="font-size: 12px;">{{ expense.category or '未分类' }}</p>
                            </div>
                            <div class="flex-grow-1">
                                <small class="text-muted">用途:</small>
                                <p style="font-size: 12px;">{{ expense.purpose }}</p>
                            </div>
                        </div>
                        
                        {% if expense.note %}
                        <div class="mt-2">
                            <small class="text-muted">备注:</small>
                            <p style="font-size: 12px;">{{ expense.note }}</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="mt-3 text-right">
                        <a href="{{ url_for('stats.edit_expense', expense_id=expense.id) }}" class="btn btn-sm btn-warning">
                            编辑
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- PC设备：表格布局 -->
        <div class="table-responsive d-none d-md-block">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th width="50%">用途</th>
                        <th>类别</th>
                        <th>
                            <div class="form-check">
                                <input type="checkbox" id="select-all-table" class="form-check-input">
                            </div>
                        </th>
                        <th>金额</th>
                        <th>备注</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for expense in expenses %}
                    <tr class="expense-table-row" data-id="{{ expense.id }}">
                        <td>{{ expense.date }}</td>
                        <td>{{ expense.purpose }}</td>
                        <td>{{ expense.category or '未分类' }}</td>
                        <td>
                            <div class="form-check">
                                <input type="checkbox" class="expense-checkbox form-check-input" value="{{ expense.id }}">
                            </div>
                        </td>
                        <td class="text-primary font-bold">¥{{ "%.2f"|format(expense.amount or 0) }}</td>
                        <td>{{ expense.note or '-' }}</td>
                        <td>
                            <a href="{{ url_for('stats.edit_expense', expense_id=expense.id) }}" class="btn btn-sm btn-warning">
                                编辑
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% else %}
        <div class="card p-5 text-center">
            <p class="text-muted">暂无孤立支出记录</p>
        </div>
        {% endif %}
        
        <!-- 总计卡片 -->
        <div class="card mt-4 border-primary">
            <div class="card-body">
                <div class="text-right">
                    <span class="text-xl font-bold">总计: ¥{{ "%.2f"|format(total_amount) }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加项目模态框 -->
<div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProjectModalLabel">添加新项目</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="add-project-form">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="project-name" class="form-label">项目名称</label>
                        <input type="text" id="project-name" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="project-description" class="form-label">项目描述</label>
                        <textarea id="project-description" name="description" class="form-control"></textarea>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-success">添加项目</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 项目选择模态框 -->
<div class="modal fade" id="projectModal" tabindex="-1" aria-labelledby="projectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="projectModalLabel">选择归属项目</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 使用实际的表单标签，而不是只有ID -->
                <form id="project-assign-form" method="POST" action="/batch_assign_project">
                    <input type="hidden" id="selected-expense-ids" name="expense_ids">
                    <div class="mb-3">
                        <label for="project_id" class="form-label">选择项目</label>
                        <select class="form-select" id="project_id" name="project_id" required>
                            <option value="">请选择项目</option>
                            {% for p in projects %}
                            <option value="{{ p.id }}">{{ p.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="text-end">
                        <button id="open-add-project-modal" type="button" class="text-primary text-sm bg-transparent border-none p-0" style="cursor: pointer; text-decoration: underline; text-decoration-thickness: from-font;">添加新项目</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="submit" form="project-assign-form" class="btn btn-primary">确认分配</button>
            </div>
        </div>
    </div>
</div>


<script>
// 复选框全选/取消全选
const selectAllCheckbox = document.getElementById('select-all');
const selectAllTableCheckbox = document.getElementById('select-all-table');
const expenseCheckboxes = document.querySelectorAll('.expense-checkbox');
const batchAssignBtn = document.getElementById('batch-assign-btn');

// 为两个全选复选框添加相同的点击事件
function handleSelectAll() {
    const isChecked = this.checked;
    expenseCheckboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
    });
    updateSelectedStats();
}

if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', handleSelectAll);
}
if (selectAllTableCheckbox) {
    selectAllTableCheckbox.addEventListener('change', handleSelectAll);
}

// 为每个支出复选框添加点击事件
expenseCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateSelectedStats);
    
    // 防止点击复选框时触发父元素的点击事件
    checkbox.addEventListener('click', function(e) {
        e.stopPropagation();
    });
});

// 为每个卡片添加点击事件
const cards = document.querySelectorAll('.expense-card');
cards.forEach(card => {
    const checkbox = card.querySelector('.expense-checkbox');
    if (!checkbox) {
        return;
    }
    
    card.addEventListener('click', function(e) {
        // 如果点击的是按钮或链接，不触发卡片的点击事件
        if (e.target.tagName === 'BUTTON' || 
            e.target.closest('button') || 
            e.target.tagName === 'A' || 
            e.target.closest('a')) {
            return;
        }
        
        // 切换复选框状态
        checkbox.checked = !checkbox.checked;
        
        // 更新选中统计信息
        updateSelectedStats();
    });
});

// 为表格行添加点击事件
const expenseTableRows = document.querySelectorAll('tr.expense-table-row');
expenseTableRows.forEach(row => {
    const checkbox = row.querySelector('.expense-checkbox');
    if (!checkbox) {
        return;
    }
    
    row.addEventListener('click', function(e) {
        // 如果点击的是按钮、链接或复选框，不触发行的点击事件
        if (e.target.tagName === 'BUTTON' || 
            e.target.closest('button') || 
            e.target.tagName === 'A' || 
            e.target.closest('a') ||
            e.target.tagName === 'INPUT') {
            return;
        }
        
        // 切换复选框状态
        checkbox.checked = !checkbox.checked;
        
        // 更新选中统计信息
        updateSelectedStats();
    });
});

// 更新选中状态统计信息
function updateSelectedStats() {
    let selectedCount = 0;
    let selectedAmount = 0;
    
    expenseCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
            selectedCount++;
            // 获取对应的支出记录数据
            const row = checkbox.closest('.expense-card') || checkbox.closest('tr');
            if (row) {
                // 从金额单元格或元素中提取金额
                const amountElement = row.querySelector('.text-primary.font-bold') || 
                                     row.querySelector('.text-xl.font-bold.text-primary');
                if (amountElement) {
                    const amountText = amountElement.textContent;
                    const amount = parseFloat(amountText.replace(/[^0-9.]/g, ''));
                    if (!isNaN(amount)) {
                        selectedAmount += amount;
                    }
                }
            }
        }
    });
    
    // 更新界面显示
    const selectedStats = document.getElementById('selected-stats');
    const selectedCountElement = document.getElementById('selected-count');
    const selectedAmountElement = document.getElementById('selected-amount');
    
    if (selectedCount > 0) {
        selectedStats.style.display = 'block';
        selectedCountElement.textContent = selectedCount;
        selectedAmountElement.textContent = selectedAmount.toFixed(2);
        batchAssignBtn.disabled = false;
    } else {
        selectedStats.style.display = 'none';
        batchAssignBtn.disabled = true;
    }
    
    // 更新全选复选框状态
    const allChecked = selectedCount === expenseCheckboxes.length;
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = allChecked;
    }
    if (selectAllTableCheckbox) {
        selectAllTableCheckbox.checked = allChecked;
    }
}

// 归属项目按钮点击事件
batchAssignBtn.addEventListener('click', function() {
    // 收集选中的支出ID
    const selectedIds = [];
    expenseCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
            selectedIds.push(checkbox.value);
        }
    });
    
    // 设置到隐藏字段
    document.getElementById('selected-expense-ids').value = selectedIds.join(',');
    
    // 显示项目选择模态框
    const projectModal = new bootstrap.Modal(document.getElementById('projectModal'));
    projectModal.show();
});

// 添加项目按钮点击事件
document.getElementById('add-project-btn').addEventListener('click', function() {
    const addProjectModal = new bootstrap.Modal(document.getElementById('addProjectModal'));
    addProjectModal.show();
});

// 打开添加项目模态框链接点击事件
document.getElementById('open-add-project-modal').addEventListener('click', function() {
    const projectModal = bootstrap.Modal.getInstance(document.getElementById('projectModal'));
    if (projectModal) {
        projectModal.hide();
    }
    
    setTimeout(() => {
        const addProjectModal = new bootstrap.Modal(document.getElementById('addProjectModal'));
        addProjectModal.show();
    }, 300);
});

// 添加项目表单提交处理
document.getElementById('add-project-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/add_project', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 关闭添加项目模态框
            const addProjectModal = bootstrap.Modal.getInstance(document.getElementById('addProjectModal'));
            addProjectModal.hide();
            
            // 刷新项目选择下拉框
            const projectSelect = document.getElementById('project_id');
            const newOption = document.createElement('option');
            newOption.value = data.project_id;
            newOption.textContent = data.project_name;
            newOption.selected = true;
            projectSelect.appendChild(newOption);
            
            // 显示项目选择模态框
            const projectModal = new bootstrap.Modal(document.getElementById('projectModal'));
            projectModal.show();
        } else {
            alert('添加项目失败: ' + (data.message || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('添加项目时发生错误');
    });
});
</script>
{% endblock %}