{% extends "base.html" %}

{% block content %}
<div class="card shadow">
    <div class="card-body">
        <h2 class="card-title mb-4">项目统计</h2>
        <div class="mb-3">
            <a href="{{ url_for('projects.add_project') }}" class="btn btn-primary">添加项目</a>
            <a href="{{ url_for('projects.manage_projects') }}" class="btn btn-secondary ml-2">项目管理</a>
            <a href="{{ url_for('projects.view_all_projects') }}" class="btn btn-info ml-2">查看所有项目</a>
            <a href="{{ url_for('stats.project_payment_stats') }}" class="btn btn-success ml-2">项目回款统计</a>
            <a href="{{ url_for('stats.expense_payment_status') }}" class="btn btn-warning ml-2">支出回款详情</a>
        </div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>项目信息</th>
                        <th>状态</th>
                        <th>支出总额</th>
                        <th style="font-weight: bold;">未报销金额</th>
                        <th>已提交金额</th>
                        <th>已回款金额</th>
                        <th>未回款金额</th>
                        <th>备注</th>
                        <th style="width: 100px;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 先显示项目id为None的无项目支出 -->
                    {% for item in stats %}
                        {% if not item.id %}
                        <tr>
                            <td><small>({{ item.id }})</small>{{ item.name }}</td>
                            <td>
                                <span class="badge {% if item.status == '进行中' %}bg-primary{% elif item.status == '已完成' %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ item.status }}
                                </span>
                            </td>
                            <td>{{ "¥%.2f"|format(item.total_expense or 0) }}</td>
                            <td style="font-weight: bold;">{{ "¥%.2f"|format((item.total_expense or 0) - (item.submitted_amount or 0)) }}</td>
                            <td>{{ "¥%.2f"|format(item.submitted_amount or 0) }}</td>
                            <td>{{ "¥%.2f"|format(item.paid_amount or 0) }}</td>
                            <td>{{ "¥%.2f"|format(item.unpaid_amount or 0) }}</td>
                            <td>{{ item.note }}</td>
                            <td>
                                <a href="{{ url_for('stats.orphan_expenses') }}" class="btn btn-sm btn-outline-primary">
                                    查看明细
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- 再显示其他正常项目 -->
                    {% for item in stats %}
                        {% if item.id %}
                        <tr>
                            <td><small>({{ item.id }})</small>{{ item.name }}</td>
                            <td>
                                <span class="badge {% if item.status == '进行中' %}bg-primary{% elif item.status == '已完成' %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ item.status }}
                                </span>
                            </td>
                            <td>{{ "¥%.2f"|format(item.total_expense or 0) }}</td>
                            <td style="font-weight: bold;">{{ "¥%.2f"|format((item.total_expense or 0) - (item.submitted_amount or 0)) }}</td>
                            <td>{{ "¥%.2f"|format(item.submitted_amount or 0) }}</td>
                            <td>{{ "¥%.2f"|format(item.paid_amount or 0) }}</td>
                            <td>{{ "¥%.2f"|format(item.unpaid_amount or 0) }}</td>
                            <td>{{ item.note }}</td>
                            <td>
                                <a href="{{ url_for('stats.expenses', project_id=item.id) }}" class="btn btn-sm btn-outline-primary">
                                    查看明细
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="bg-light font-weight-bold">
                        <td>总计</td>
                        <td></td> <!-- 状态列 -->
                        <td>{{ "¥%.2f"|format(stats|sum(attribute='total_expense', start=0)) }}</td>
                        <td style="font-weight: bold;">{{ "¥%.2f"|format(stats|sum(attribute='total_expense', start=0) - stats|sum(attribute='submitted_amount', start=0)) }}</td>
                        <td>{{ "¥%.2f"|format(stats|sum(attribute='submitted_amount', start=0)) }}</td>
                        <td>{{ "¥%.2f"|format(stats|sum(attribute='paid_amount', start=0)) }}</td>
                        <td>{{ "¥%.2f"|format(stats|sum(attribute='unpaid_amount', start=0)) }}</td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div id="orphan-expenses-total" class="mt-4">
            <h6>没能归属到以上项目的支出统计<small>（导入不规范的模板数据所致）</small></h6>
            <div id="orphan-expenses-container" class="mt-2">
                <p>加载中...</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 加载无项目支出统计
    fetch('/orphan_expenses_stats')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('orphan-expenses-container');
            if (data.total_count > 0) {
                container.innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">支出笔数</h5>
                                    <p class="card-text display-4">${data.total_count}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">支出总额</h5>
                                    <p class="card-text display-4">¥${data.total_amount.toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">涉及分类</h5>
                                    <p class="card-text display-4">${data.category_count}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('stats.orphan_expenses') }}" class="btn btn-outline-primary">查看无项目支出明细</a>
                    </div>
                `;
            } else {
                container.innerHTML = '<p class="text-muted">暂无无项目支出记录</p>';
            }
        })
        .catch(error => {
            console.error('Error loading orphan expenses stats:', error);
            document.getElementById('orphan-expenses-container').innerHTML = '<p class="text-danger">加载失败</p>';
        });
});
</script>
{% endblock %}