{% extends "base.html" %}

{% block content %}
<div class="card shadow">
    <div class="card-body">
        <h2 class="card-title mb-4">项目统计</h2>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>项目信息</th>
                        <th>项目金额</th>
                        <th>支出总额</th>
                        <th>毛利润</th>
                        <th>备注</th>
                        <th style="width: 100px;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 先显示项目id为None的无项目支出 -->
                    {% for item in stats %}
                        {% if not item.id %}
                        <tr>
                            <td><small>({{ item.id }})</small>{{ item.name }}</td>
                            <td>{{ "¥%.2f"|format(item.project_amount) }}</td>
                            <td>{{ "¥%.2f"|format(item.total_expense or 0) }}</td>
                            <td>{{ "¥%.2f"|format(item.project_amount - (item.total_expense or 0)) }}</td>
                            <td>{{ item.note }}</td>
                            <td>
                                <a href="{{ url_for('stats.orphan_expenses') }}" class="btn btn-sm btn-outline-primary">
                                    查看明细
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- 再显示其他正常项目 -->
                    {% for item in stats %}
                        {% if item.id %}
                        <tr>
                            <td><small>({{ item.id }})</small>{{ item.name }}</td>
                            <td>{{ "¥%.2f"|format(item.project_amount) }}</td>
                            <td>{{ "¥%.2f"|format(item.total_expense or 0) }}</td>
                            <td>{{ "¥%.2f"|format(item.project_amount - (item.total_expense or 0)) }}</td>
                            <td>{{ item.note }}</td>
                            <td>
                                <a href="{{ url_for('stats.expenses', project_id=item.id) }}" class="btn btn-sm btn-outline-primary">
                                    查看明细
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="bg-light font-weight-bold">
                        <td>总计</td>
                        <td>{{ "¥%.2f"|format(stats|sum(attribute='project_amount', start=0)) }}</td>
                        <td>{{ "¥%.2f"|format(stats|sum(attribute='total_expense', start=0)) }}</td>
                        <td>{{ "¥%.2f"|format(stats|sum(attribute='project_amount', start=0) - stats|sum(attribute='total_expense', start=0)) }}</td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div id="orphan-expenses-total" class="mt-4">
            <h6>没能归属到以上项目的支出统计<small>（导入不规范的模板数据所致）</small></h6>
            <div id="orphan-expenses-container" class="mt-2">
                <p>加载中...</p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    fetch('/get_orphan_expenses_total')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            const container = document.getElementById('orphan-expenses-container');
            if (data.length === 0) {
                container.innerHTML = '<p>没有孤立支出</p>';
                return;
            }
            container.innerHTML = '';
            data.forEach(item => {
                const button = document.createElement('button');
                button.className = 'btn btn-sm btn-primary mb-2';
                button.innerHTML = `¥${item.total_amount.toFixed(2)}`;
                button.addEventListener('click', () => {
                    window.location.href = '/orphan_expenses';
                });
                container.appendChild(button);
            });
        })
        .catch(error => {
            console.error('Error fetching orphan expenses total:', error);
            const container = document.getElementById('orphan-expenses-container');
            container.innerHTML = '<p>加载失败</p>';
        });
});
</script>
{% endblock %}